resource "azurerm_web_application_firewall_policy" "wafpolicy" {
  name                = "waf-policy01-pdp-${var.environment}"
  resource_group_name = var.resource_group_name
  location            = var.location

  managed_rules {
    managed_rule_set {
      type    = "OWASP"
      version = "3.2"
      rule_group_override {
        rule_group_name = "REQUEST-942-APPLICATION-ATTACK-SQLI"
        disabled_rules = [
          "942420",
          "942440"
        ]
      }
    }
    exclusion {
      match_variable          = "RequestCookieNames"
      selector_match_operator = "Equals"
      selector                = "pdpreact"
    }
  }

  custom_rules {
    name      = "Log4j"
    priority  = 2
    rule_type = "MatchRule"

    match_conditions {
      match_variables {
        variable_name = "RemoteAddr"
      }

      operator           = "IPMatch"
      negation_condition = false
      match_values = [
        "103.214.5.13",
        "104.244.72.115",
        "104.244.74.57",
        "107.189.1.160",
        "107.189.1.178",
        "107.189.12.135",
        "171.25.193.20",
        "171.25.193.25",
        "171.25.193.77",
        "171.25.193.78",
        "18.27.197.252",
        "185.107.47.171",
        "185.107.47.215",
        "185.107.70.56",
        "185.129.61.1",
        "185.129.61.4",
        "185.130.44.108",
        "185.14.97.147",
        "185.220.100.240",
        "185.220.100.241",
        "185.220.100.242",
        "185.220.100.243",
        "185.220.100.244",
        "185.220.100.245",
        "185.220.100.246",
        "185.220.100.247",
        "185.220.100.248",
        "185.220.100.249",
        "185.220.100.250",
        "185.220.100.251",
        "185.220.100.252",
        "185.220.100.253",
        "185.220.100.254",
        "185.220.100.255",
        "185.220.101.129",
        "185.220.101.131",
        "185.220.101.132",
        "185.220.101.133",
        "185.220.101.134",
        "185.220.101.135",
        "185.220.101.138",
        "185.220.101.139",
        "185.220.101.140",
        "185.220.101.141",
        "185.220.101.142",
        "185.220.101.143",
        "185.220.101.144",
        "185.220.101.145",
        "185.220.101.147",
        "185.220.101.148",
        "185.220.101.149",
        "185.220.101.150",
        "185.220.101.151",
        "185.220.101.152",
        "185.220.101.153",
        "185.220.101.154",
        "185.220.101.155",
        "185.220.101.156",
        "185.220.101.157",
        "185.220.101.158",
        "185.220.101.159",
        "185.220.101.160",
        "185.220.101.161",
        "185.220.101.162",
        "185.220.101.163",
        "185.220.101.164",
        "185.220.101.165",
        "185.220.101.167",
        "185.220.101.168",
        "185.220.101.169",
        "185.220.101.170",
        "185.220.101.171",
        "185.220.101.172",
        "185.220.101.173",
        "185.220.101.174",
        "185.220.101.175",
        "185.220.101.176",
        "185.220.101.177",
        "185.220.101.178",
        "185.220.101.179",
        "185.220.101.180",
        "185.220.101.181",
        "185.220.101.182",
        "185.220.101.183",
        "185.220.101.184",
        "185.220.101.185",
        "185.220.101.186",
        "185.220.101.187",
        "185.220.101.188",
        "185.220.101.189",
        "185.220.101.190",
        "185.220.101.191",
        "185.220.101.32",
        "185.220.101.33",
        "185.220.101.34",
        "185.220.101.35",
        "185.220.101.36",
        "185.220.101.37",
        "185.220.101.38",
        "185.220.101.39",
        "185.220.101.41",
        "185.220.101.42",
        "185.220.101.43",
        "185.220.101.44",
        "185.220.101.45",
        "185.220.101.46",
        "185.220.101.48",
        "185.220.101.49",
        "185.220.101.50",
        "185.220.101.51",
        "185.220.101.52",
        "185.220.101.53",
        "185.220.101.54",
        "185.220.101.55",
        "185.220.101.56",
        "185.220.101.57",
        "185.220.101.58",
        "185.220.101.60",
        "185.220.101.61",
        "185.220.101.62",
        "185.220.101.63",
        "185.220.102.241",
        "185.220.102.242",
        "185.220.102.246",
        "185.220.102.249",
        "185.220.102.252",
        "185.220.102.253",
        "185.220.102.254",
        "185.220.102.7",
        "185.220.102.8",
        "185.220.103.119",
        "185.220.103.4",
        "185.220.103.7",
        "185.232.23.46",
        "185.244.214.217",
        "185.38.175.132",
        "185.56.80.65",
        "193.110.95.34",
        "193.189.100.195",
        "193.189.100.201",
        "193.189.100.203",
        "193.218.118.183",
        "193.218.118.231",
        "193.31.24.154",
        "195.176.3.24",
        "198.98.51.189",
        "198.98.60.19",
        "199.195.250.77",
        "204.8.156.142",
        "205.185.117.149",
        "209.127.17.242",
        "209.141.41.103",
        "209.141.45.189",
        "209.141.45.227",
        "23.120.182.121",
        "23.129.64.131",
        "23.129.64.141",
        "23.129.64.146",
        "23.129.64.148",
        "45.12.134.108",
        "45.155.205.233",
        "46.166.139.111",
        "46.182.21.248",
        "51.15.43.205",
        "62.102.148.69",
        "81.17.18.60",
        "94.142.241.194",
        "94.230.208.147",
        "104.244.72.7",
        "104.244.73.43",
        "104.244.74.211",
        "104.244.75.74",
        "104.244.76.13",
        "104.244.76.170",
        "104.244.76.173",
        "104.244.77.235",
        "104.244.78.213",
        "104.244.79.6",
        "107.189.10.137",
        "107.189.11.153",
        "107.189.14.182",
        "107.189.14.76",
        "107.189.14.98",
        "107.189.29.107",
        "107.189.29.41",
        "107.189.31.241",
        "107.189.8.65",
        "109.70.100.26",
        "109.70.100.27",
        "109.70.100.28",
        "109.70.100.34",
        "109.70.100.36",
        "135.148.43.32",
        "162.247.74.202",
        "195.206.105.217",
        "62.171.142.3",
        "64.113.32.29",
        "104.244.72.129",
        "151.80.148.159",
        "172.106.17.218",
        "176.10.104.240",
        "176.10.99.200",
        "185.83.214.69",
        "195.176.3.19",
        "212.193.30.142",
        "45.13.104.179",
        "45.153.160.2",
        "45.154.255.147",
        "81.17.18.61",
        "81.17.18.62",
        "137.184.111.180",
        "137.184.96.216",
        "159.89.113.255",
        "37.233.99.127",
        "45.153.160.130",
        "5.199.143.202",
        "51.38.92.223",
        "85.10.195.175"
      ]
    }
    action = "Block"
  }

  policy_settings {
    enabled                     = true
    mode                        = "Prevention"
    request_body_check          = false
    file_upload_limit_in_mb     = 100
    max_request_body_size_in_kb = 128
  }
}